<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>From Monolith To Micoservices</title>

		<meta name="description" content="Test-Driven Decoupling">
		<meta name="author" content="R. Owen Rogers">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="../lib/reveal.js/css/reveal.css">
		<link rel="stylesheet" href="../lib/reveal.js/css/theme/night.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="../lib/reveal.js/lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<link rel="stylesheet" href="../lib/reveal.js/css/print/pdf.css" type="text/css" media="print">'
		<style>
			.reveal section img { border: none; background-color: black; }
		</style>
	</head>

	<body>

		<div class="reveal">
			<div class="slides">

				<section data-state="title-slide">
					<h1>From Monolith To Microservices</h1>
					<h3>Agile In The Cloud 2016</h3>
					<p>
						<small><a href="http://exortech.com/">Owen Rogers</a> - <a href="http://twitter.com/exortech">@exortech</a></small>
						<br/>
						<small><a href="">Nic Waller</a> - <a href="http://twitter.com/nic_waller">@nic_waller</a></small>
					</p>
				</section>

				<section>
					<section data-state="intro-slide">
						<h2>Hi!</h2>
					</section>
					<section data-state="intro-slide">
						<img src="../common/img/owen-faro.jpg" />
						<p><a href="http://exortech.com/blog">Owen Rogers</a> / <a href="http://twitter.com/exortech">@exortech</a></p>
						<p>Lead Consultant @ <a href="http://www.exortech.com">Exortech Consulting</a>
						<p>(formerly) Product Owner @ <a href="http://www.enernoc.com">EnerNOC</a>
					</section>
					<section data-state="intro-slide">
						<img src="img/NicCimos2011-profile.jpg" />
						<p><a href="http://exortech.com/blog">Nic Waller</a> / <a href="http://twitter.com/nic_waller">@nic_waller</a></p>
						<p>Site Reliability Engineer @ <a href="http://www.enernoc.com">EnerNOC</a>
					</section>
				</section>
				<section>
					<section>
						<h2>An 8-year Odyssey</h2>
						<img src="img/2008-poster.jpg" />
					</section>
					<section>
						<h2>The Unintended Monolith</h2>
						<img src="img/2001-monolith.png" />
					</section>
					<section>
						<h2>mon路o路lith路ic</h2>
						<p><em>characterized by massiveness, total uniformity, rigidity, invulnerability, etc.</em></p>
					</section>
					<section>
						<h2>Monolithic Pain</h2>
						<p>
							<ul>
								<li class="fragment">Code encumbrance</li>
								<li class="fragment">Regression costs</li>
								<li class="fragment">Less frequent deployments</li>
								<li class="fragment">Inefficient system scalability</li>
								<li class="fragment">Less resilient</li>
								<li class="fragment">Harder to scale teams</li>
							</ul>
						</p>
					</section>
				</section>
				<section>
					<section>
						<h2>Why did we end up with a monolith?</h2>
						<img src="img/monolith-sun.jpg" height="400px" />
					</section>
					<section>
						<h2>New and rapidly evolving system</h2>
						<img src="img/apes-monolith.gif" />
					</section>
					<section>
						<h2>Canalizing Design</h2>
						<img src="img/aquaduct.jpg" height="400px" />
						<p><small><a href="http://michaelfeathers.typepad.com/michael_feathers_blog/2009/06/canalizing-design.html">http://michaelfeathers.typepad.com/michael_feathers_blog/2009/06/canalizing-design.html</a></small></p>
					</section>
					<section>
						<h2>Make HAL do something else</h2>
						<pre>
							<code class="JavaScript">
function askHAL(action) {
	if (isReadMe(action) {
		return "Affirmative, Dave. I read you.";
	} else if (isLeaveMessage(action)) {
		return "It is dangerous to remain here. You must leave within two days.";
	}
	return "I'm sorry, Dave. I'm afraid I can't do that.";
}
							</code>
						</pre>
					</section>
					<section>
						<h2>Path of least resistance</h2>
						<img src="img/path_of_least_resistance.jpg" height="500px" />
					</section>
					<section>
						<h2>ac路crete</h2>
						<ol>
							<li>Grow by accumulation or coalescence</li>
							<li>Form (a composite whole or a collection of things) by gradual accumulation</li>
						</ol>
					</section>
					<section>
						<h2>Big Ball Of Mud</h2>
						<img src="img/DungBeetle-on-dung.JPG" />
					</section>
					<section>
						<h2>Rationalizing the monolith</h2>
						<p>
							<ul>
								<li class="fragment">Simplicity: one system</li>
								<li class="fragment">New domain: where are the context boundaries?</li>
								<li class="fragment">Never the right time to split</li>
								<li class="fragment">Conway's law</li>
								<li class="fragment">Lots of barriers</li>
							</ul>
						</p>
					</section>
					<section>
						<h2>Barriers to service-orientation</h2>
						<p>
							<ul>
								<li class="fragment">Technology</li>
								<li class="fragment">Shared code</li>
								<li class="fragment">Versioning</li>
								<li class="fragment">Deployment</li>
								<li class="fragment">Messaging and APIs</li>
								<li class="fragment">Security</li>
								<li class="fragment">Monitoring and alerting</li>
								<li class="fragment">Performance</li>
							</ul>
						</p>
					</section>
				</section>

				<section>
					<section>
						<h2>What's the alternative?</h2>
						<img src="img/2001-space-odyssey-monolith.jpg" height="400px" />
					</section>
					<section>
						<h2>Alternative #1: Split the monolith</h2>
						<img src="img/dave.jpg" height="400px" />
						<h3>But how?</h3>
					</section>
					<section>
						<h2>Easy right?</h2>
						<ol>
							<li>Pull related functionality into a separate module</li>
							<li>Package module as a service</li>
							<li>Deploy</li>
							<li>Profit!</li>
						<ol>
					</section>
					<section>
						<h2>Not so fast, Dave</h2>
						<img src="img/HAL.jpg" height="400px" />
					</section>
					<section>
						<h2>Alien goo</h2>
						<img src="img/alien-goo.jpg" />
					</section>

					<section>
						<h2>Test-driven decoupling</h2>
						<img src="img/ship.jpg" height="400px" />
						<p>Using tests to enforce package structure and drive decoupling effort</p>
					</section>

					<section>
						<h2>Alternative #2: Write new service</h2>
						<img src="img/dave.jpg" height="400px" />
					</section>

					<section>
						<h2>Strangler application</h2>
						<img src="img/face-sucker-free-hugs.jpg" height="400px" />
						<p><a href="http://www.martinfowler.com/bliki/StranglerApplication.html">http://www.martinfowler.com/bliki/StranglerApplication.html</a></p>
					</section>

					<section>
						<h2>Hub and spokes</h2>
						<img src="img/2001-space-station.jpg" height="400px" />
					</section>
				</section>

				<section>
					<section>
						<h2>So, how do we get from</h2>
						<img src="img/monolith.jpg" style="vertical-align:middle" />
						<span style="font-size:300%">&rarr;</span>
						<img src="img/unicornrainbow1.jpg" style="vertical-align:middle" />
					</section>

					<section>
						<h2>Or Even</h2>
						<img src="img/monolith.jpg" style="vertical-align:middle" />
						<span style="font-size:300%">&rarr;</span>
						<img src="img/monolith.jpg" style="vertical-align:middle; height:30%" />
						<span style="font-size:300%">+</span>
						<img src="img/monolith.jpg" style="vertical-align:middle; height:30%" />
					</section>

					<section>
						<img src="img/building_microservices_book.jpg" height="400px" />
						<h3>Building Microservices - Sam Newman</h3>
					</section>

				</section>

				<section>
					<section>
						<h2>First, a brief digression...</h2>
						<img src="img/dave-tunnel.jpg" />
					</section>
					<section>
						<h2>Who hasn't read this book?</h2>
						<img src="img/domain-driven-design.jpg" height="400px" />
					</section>
					<section>
						<h2>Package design</h2>
						<img src="img/200px-Collected_stories_clarke.jpg" height="300px" />
						<h3>Package = directory, namespace, module, etc.</h3>
					</section>
					<section>
						<h2>Maximize cohesion within a package</h2>
						<img src="img/cohesion.png" height="400px" />
					</section>
					<section>
						<h2>Minimize coupling</h2>
						<img src="img/coupling.png" height="400px" />
					</section>
					<section>
						<h2>Look familiar?</h2>
						<img src="img/layer-diagram.png" />
					</section>
					<section>
						<h2>What's wrong with this model?</h2>
						<img src="img/package-diagram.png" />
					</section>
					<section>
						<h2>Let's look inside</h2>
						<img src="img/package-diagram-details.png" />
					</section>
					<section>
						<h2>Ewww - maximum alien goo</h2>
						<img src="img/alien-goo.jpg" />
					</section>
					<section>
						<h2>Structure packages by domain context</h2>
						<img src="img/package-domain.png" />
						<h3>Makes extracting into services much easier!</h3>
					</section>
				</section>

				<section>
					<section>
						<h2>So back to</h2>
						<img src="img/monolith.jpg" style="vertical-align:middle" />
						<span style="font-size:300%">&rarr;</span>
						<img src="img/monolith.jpg" style="vertical-align:middle; height:30%" />
						<span style="font-size:300%">+</span>
						<img src="img/monolith.jpg" style="vertical-align:middle; height:30%" />
					</section>
					<section>
						<h2>Modularization Process</h2>
						<ol>
							<li>Pull related functionality into a common package (maximize cohesion)</li>
							<li>Restructure code to sever unnecessary external dependencies (minimize coupling)</li>
							<li>Extract package into an independent component/module</li>
							<li>Servicify module</li>
							<li>Profit!</li>
						</ol>
					</section>
					<section>
						<h2>Great! But this is hard...</h2>
						<img src="img/dave_ship.jpg" height="400px" />
					</section>
					<section>
						<h2>Test-driven decoupling</h2>
						<h3>(to the rescue!)</h3>
						<img src="img/ship.jpg" height="400px" />
					</section>
					<section>
						<h2>Test-driven decoupling</h2>
						<p>Use tests to enforce package structure and support decoupling effort</p>
					</section>
					<section>
						<h2>Tools</h2>
						<img src="img/tools.jpg" height="400px" />
						<h3>Free, open source tools that you are probably already using</h3>
					</section>
					<section>
						<h2>JDepend</h2>
						<p><a href="http://clarkware.com/software/JDepend.html">http://clarkware.com/software/JDepend.html</a></p>
					</section>
					<section>
						<h2>NDepend</h2>
						<p><a href="http://www.ndepend.com/">http://www.ndepend.com/</a></p>
					</section>
					<section>
						<h2>MaDGe - Module Dependency Graph</h2>
						<p><a href="https://github.com/pahen/node-madge">https://github.com/pahen/node-madge/</a></p>
					</section>

					<section>
						<h2>What about external dependencies?</h2>
					</section>
					<section>
						<h3>I'm sorry, Dave. This mission is too important for me to allow you to jeopardize it.</h3>
						<img src="img/HAL.jpg" height="400px" />
					</section>
					<section>
						<h2>Focus on the code you own</h2>
						<img src="img/dave-suit.jpg" />
					</section>

				</section>

				<section>
					<section>
						<h2>Examples</h2>
						<img src="img/junit-logo.png" height="90px" style="vertical-align:middle" />
						<span style="font-size: 200%">+</span>
						<img src="img/jdepend.png" height="80px"  style="vertical-align:middle" />
					</section>
					<section>
						<h2>Example 1: Starting point</h2>
						<img src="img/1.png" />
					</section>

					<section>
						<h2>core &rarr; util</h2>
						<pre>
						<code class="java">
  @Test
  public void corePackageShouldOnlyDependOn_util() throws Exception {
    Set&lt;String&gt; valid = ImmutableSortedSet.of("com.pulseenergy.util");
    assertThat(findInternalDependencies("com.pulseenergy.core"), is(valid));
  }
						</code>
					</pre>
					</section>
					<section>
						<h2>system &rarr; { util, core }</h2>
						<pre>
						<code class="java">
  @Test
  public void systemPackageShouldOnlyDependOn_core_util() throws Exception {
    Set&lt;String&gt; valid = ImmutableSortedSet.of(
      "com.pulseenergy.core", "com.pulseenergy.util");
    assertThat(findInternalDependencies("com.pulseenergy.system"), is(valid));
  }
						</code>
					</pre>
					</section>

					<section>
						<h2>Example 2: Invalid dependency</h2>
						<img src="img/2.png" />
					</section>
					<section>
						<h2>security &rarr; { core, spring, system, util }</h2>
						<pre>
						<code class="java">
  @Test
  public void securityPackageShouldOnlyDependOn_core_springSecurity_system_util() {
    Set&lt;String&gt; valid = ImmutableSortedSet.of(
      "com.pulseenergy.core", "com.pulseenergy.spring.security",
      "com.pulseenergy.system", "com.pulseenergy.util");
    Set&lt;String&gt; invalid = ImmutableSortedSet.of("com.pulseenergy.web.filter"); // invalid dep
    assertThat(findInternalDependencies("com.pulseenergy.security"),
      is(ImmutableSortedSet.of(valid, invalid)));
  }
						</code>
					</pre>
					</section>
					<section>
						<h2>Test Writing Process</h2>
						<ol>
							<li>Write a failing test to capture the existing dependencies (Red bar)</li>
							<li>Assert all existing dependencies (Green bar)</li>
							<li>Split dependencies into valid and invalid sets</li>
							<li>Remove one invalid dependencies from the set (Red bar)</li>
							<li>Break that dependencies in the code (Green bar)</li>
							<li>Lather (commit) and repeat</li>
						</ol>
					</section>
					<section>
						<h2>1. Capture the existing dependencies: foo &rarr; ???</h2>
						<pre>
							<code>
  @Test
  public void fooShouldDependOnX() {
    assertThat(findInternalDependencies("com.pulseenergy.foo"),
    	is(Collections.emptySet()));
  }
							</code>
						</pre>
					</section>
					<section>
						<h2>2. assert existing dependencies (green bar)</h2>
						<pre>
							<code>
  @Test
  public void fooShouldDependOnX() {
    assertThat(findInternalDependencies("com.pulseenergy.foo"),
    	is(ImmutableSortedSet.of("com.pulseenergy.bar", "com.pulseenergy.baz")));
  }
							</code>
						</pre>
					</section>
					<section>
						<h2>3. split into valid/invalid sets (green bar)</h2>
						<pre>
							<code>
  @Test
  public void fooShouldDependOnBar() {
    Set&lt;String&gt; valid = ImmutableSortedSet.of("com.pulseenergy.bar");
    Set&lt;String&gt; invalid = ImmutableSortedSet.of("com.pulseenergy.baz");
    assertThat(findInternalDependencies("com.pulseenergy.foo"),
    	is(Iterables.concat(valid, invalid)));
  }
							</code>
						</pre>
					</section>
					<section>
						<h2>4. remove invalid dependency from test (red bar)</h2>
						<pre>
							<code>
  @Test
  public void fooShouldDependOnBar() {
    Set&lt;String&gt; valid = ImmutableSortedSet.of("com.pulseenergy.bar");
    assertThat(findInternalDependencies("com.pulseenergy.foo"), is(valid));
  }
							</code>
						</pre>
					</section>
					<section>
						<h2>5. remove invalid dependency from code (green bar)</h2>
						<img src="img/space-arm.jpg" height="400px" />
					</section>
				</section>
				<section>
					<section>
						<h2>Breaking dependencies can take a long time</h2>
						<img src="img/astronauts.jpg" height="350px" />
						<h3>Commit tests with invalid dependencies listed</h3>
					</section>
					<section>
						<h2>Run these tests in your build</h2>
						<img src="img/HAL.jpg" height="400px">
						<h3>You broke the build, Dave &#9608;</h3>
					</section>
					<section>
						<h2>When package is suitably decoupled, service-ify!</h2>
						<img src="img/baby.jpg">
					</section>
				</section>
				<section>
					<section>
						<h2>Thanks!</h2>
						<img src="img/baby.jpg">
						<p><a href="mailto:owen@exortech.com">owen@exortech.com</a> | <a href="http://twitter.com/exortech">@exortech</a></p>
					</section>
					<section>
						<img src="img/2001-poster.jpg" />
						<h3>For serious geeks only</h3>
					</section>

					<section>
						<h2>Under the hood</h2>
						<pre><code>
private Collection&lt;JavaPackage&gt; analyzePackage(String targetPackage) throws IOException {
	final JDepend jDepend = new JDepend();
	jDepend.addDirectory(IntrospectionHelper.findClassesDirectory().getAbsolutePath()
		 + "/" + convertPackageToPath(targetPackage));
	@SuppressWarnings("unchecked")
	final Collection&lt;JavaPackage&gt; allPackages = jDepend.analyze();
	final List&lt;JavaPackage&gt; filteredPackages = Lists.newArrayList();
	for (JavaPackage aPackage : allPackages) {
		if (aPackage.getName().startsWith(targetPackage)) {
			filteredPackages.add(aPackage);
		}
	}
	return filteredPackages;
}
						</code></pre>
					</section>
					<section>
						<h2>Under the hood</h2>
						<pre><code>
private Set&lt;String&gt; findInvalidDependencies(JavaPackage javaPackage) {
	final Set&lt;String&gt; packageViolations = Sets.newTreeSet();
	@SuppressWarnings("unchecked")
	Collection&lt;JavaPackage&gt; efferents = javaPackage.getEfferents();
	for (JavaPackage efferentPackage : efferents) {
		if (isInternalDependency(efferentPackage)) {
			packageViolations.add(efferentPackage.getName());
		}
	}
	return packageViolations;
}
						</code></pre>
					</section>

				</section>

			</div>
		</div>

		<script src="../lib/reveal.js/lib/js/head.min.js"></script>
		<script src="../lib/reveal.js/js/reveal.js"></script>

		<script>
			Reveal.initialize({
				transition: 'fade',
			    dependencies: [
			    //     // Syntax highlight for <code> elements
        			{ src: '../lib/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
    			]
			});
		</script>

	</body>
</html>